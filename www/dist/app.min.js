;(function() {
"use strict";

function ActivityCtrl(t,e,n,i,o,a,r,c){function u(){c.showAddActivityStep1(function(e){e&&c.showAddActivityStep2(e,function(e){"countdown"===e.type?(e.duration=0,p.data=v(e),t.show(g).then(function(t){t&&(e.duration=t,e.remaining=t,n.add(e))})):e.name&&e.type&&(e.duration=0,e.remaining=0,n.add(e)),p.newActivity={}})})}function l(n){p.amount=r.getLastAmountLogged(n.name),t.show({templateUrl:"templates/popup-logmulti.html",title:"How many "+n.name+" did you do?",scope:e,buttons:[{text:"Cancel",onTap:function(t){return null}},{text:"<b>Log</b>",type:"button-positive",onTap:function(t){return p.amount}}]}).then(function(t){t&&i.add({event:n.name,amount:t})})}function s(e){t.alert({title:"You have logged a "+e.name}).then(function(){i.add({event:e.name,amount:1})})}function d(e){var e=o.toggleActivity(e);e.interval||(p.data=v(e),t.show(g).then(function(t){t&&i.add({event:e.name,duration:t}),e.duration=0}))}function v(t){var e=a("millisecondsToStringFilter")(t.duration),n=e.split(":");return{duration:{hours:parseInt(n[0],10),minutes:parseInt(n[1],10),seconds:parseInt(n[2],10),milliseconds:parseInt(n[3],10)}}}function f(t){if(t.interval){var e=moment.duration(moment().diff(t.startDate));i.add({event:t.name,duration:e.asMilliseconds()}),o.toggleCountdownActivity(t),t.remaining=t.duration}else o.toggleCountdownActivity(t)}var p=this;p.activities=n.getActivities(),p.addActivity=u,p.newActivity={},p.logSingle=s,p.logMulti=l,p.logDuration=d,p.logCountdown=f;var g={templateUrl:"templates/popup-log-duration.html",title:"Edit duration",subTitle:"Please confirm the time to log",scope:e,buttons:[{text:"Cancel",onTap:function(t){}},{text:"<b>Log</b>",type:"button-positive",onTap:function(t){return 36e5*p.data.duration.hours+6e4*p.data.duration.minutes+1e3*p.data.duration.seconds+p.data.duration.milliseconds}}]}}function activityService(){function t(){return window.localStorage.activities?JSON.parse(window.localStorage.activities):[{name:"Push ups",type:"multi"},{name:"Drank a coffee",type:"single"},{name:"Commuting",type:"duration",duration:0},{name:"Meditating",type:"countdown"}]}function e(){return["Coding","Commuting","Excercising","Meditating","Meetings","Partying"]}function n(){return[]}function i(t,e,n){u.splice(e,1),u.splice(n,0,t),c()}function o(){return u}function a(t){u.push(t),c()}function r(t){u.splice(t,1),c()}function c(){window.localStorage.activities=JSON.stringify(u)}var u=t();return{moveItem:i,getActivities:o,add:a,remove:r,getActivityTypes:e,getActionTags:n}}function activityTimingService(t,e,n,i){function o(i){function o(){var e=t.duration(t().diff(i.startDate));i.duration=e.asMilliseconds()}return i.interval?(n.cancelNotification(),e.cancel(i.interval),delete i.interval,c(i)):(n.showNotification(),i.startDate=t(),o(),i.interval=e(o,100),r(i)),i}function a(o){function a(){if(o.remaining>100){var n=t.duration(t(o.endDate).diff(t()));o.remaining=n.asMilliseconds()}else{var a=t.duration(t().diff(o.startDate));i.add({event:o.name,duration:a.asMilliseconds()}),e.cancel(o.interval),delete o.interval,c(o)}}o.interval?(n.cancelNotification(),e.cancel(o.interval),delete o.interval,c(o)):(n.showNotification(),o.startDate=t(),o.endDate=t().add(o.duration,"ms"),a(),o.interval=e(a,100),r(o))}function r(t){var e=u();e[t.title]={startDate:t.startDate},window.localStorage.active_activities=angular.toJson(e)}function c(t){var e=u();delete e[t.title],window.localStorage.active_activities=angular.toJson(e)}function u(){var t=window.localStorage.active_activities;return t?angular.fromJson(t):{}}return{toggleActivity:o,toggleCountdownActivity:a}}function DashboardEditCtrl(t){var e=this;e.activities=t.getActivities(),e.moveItem=t.moveItem,e.removeItem=t.remove}function oneSelfService(t){function e(e){var n={source:t.appName,version:t.appVersion,objectTags:["self"],actionTags:e.event,properties:{quantity:e.amount}};o.sendEvent(n,i)}function n(t){var e=o.objectTags(["self"]).actionTags(t).sum("quantity").barChart().backgroundColor("ddcc19").url(i);return e}var i,o=new Lib1selfClient(t,"sandbox");return o.fetchStream(function(t,e){i=e}),{sendEventToApi:e,getChartUrl:n}}function routesConfig(t,e){t.state("tab",{url:"/tab","abstract":!0,templateUrl:"templates/tabs.html"}).state("tab.dash",{url:"/dash",views:{"tab-dash":{templateUrl:"templates/tab-dash.html",controller:"ActivityCtrl as vm"}}}).state("tab.edit",{url:"/dash/edit",views:{"tab-dash":{templateUrl:"templates/tab-dash-edit.html",controller:"DashboardEditCtrl as vm"}}}).state("tab.history",{cache:!1,url:"/history",views:{"tab-history":{templateUrl:"templates/tab-history.html",controller:"HistoryCtrl as vm"}}}).state("tab.charts",{cache:!1,url:"/charts",views:{"tab-charts":{templateUrl:"templates/tab-charts.html",controller:"ChartCtrl as vm"}}}),e.otherwise("/tab/dash")}function NotificationService(t){function e(){window.plugin&&t.ready(function(){o++,i=window.plugin.notification.local.add({id:i,title:"Duration",message:"Timer active",date:new Date,ongoing:!0,badge:o})})}function n(){window.plugin&&t.ready(function(){o--,0===o?window.plugin.notification.local.cancelAll():window.plugin.notification.local.add({id:i,title:"Duration",message:"Timer active",ongoing:!0,sound:null,badge:o})})}var i="1",o=0;return window.localStorage.active_activities&&(o=Object.keys(angular.fromJson(window.localStorage.active_activities)).length),{showNotification:e,cancelNotification:n}}function popupService(t,n,i){function o(e){var o=n.$new();o.vm={activityTypes:i.getActivityTypes()};var a={title:"Add a new activity",subTitle:"What is the name of the activity?",templateUrl:"templates/popup-name.html",scope:o,buttons:[{text:"Cancel",onTap:function(){return null}},{text:"Next",type:"button-positive",onTap:function(t){return o.vm.newActivity?o.vm.newActivity:void t.preventDefault()}}]};t.show(a).then(e)}function a(i,o){var a=n.$new();a.vm={newActivity:i};var r={title:"Add a new activity",subTitle:"What is the type of the activity?",templateUrl:"templates/popup-add.html",scope:a,buttons:[{text:"Cancel"},{text:"Add",type:"button-positive",onTap:function(){return a.vm.newActivity.type?a.vm.newActivity:void e.preventDefault()}}]};t.show(r).then(o)}return{showAddActivityStep1:o,showAddActivityStep2:a}}function preferenceService(){function t(t,e){i.lastAmountLogged||(i.lastAmountLogged={}),i.lastAmountLogged[t]=e,n()}function e(t){return i.lastAmountLogged&&i.lastAmountLogged[t]?i.lastAmountLogged[t]:0}function n(){window.localStorage.preferences=JSON.stringify(i)}var i=JSON.parse(window.localStorage.preferences||"{}");return{setLastAmountLogged:t,getLastAmountLogged:e}}function ChartCtrl(t){window.open(t.getChartUrl(["Coding"]),"_system","location=no")}function EventSendService(t,e,n,o){var a=function(){var t=window.localStorage.events;return t?angular.fromJson(t):[]},r=function(t){var e=a();e.push(t),window.localStorage.events=angular.toJson(e)},c=function(){var t=window.localStorage.last_event_sent_index;return"undefined"==typeof t?-1:parseInt(t,10)},u=function(t){var e=c(),n=e+t;window.localStorage.last_event_sent_index=n},l=function(){var t=a(),e=c(),n=t.length;return t.slice(e+1,n)},s=function(){var o=angular.fromJson(window.localStorage.api_credentials),a={Authorization:o.writeToken,"Content-Type":"application/json"},r=function(t){return{dateTime:t.dateTime,source:n.appName,version:n.appVersion,properties:{duration:t.duration}}},c=!1,s=function(){var d=[],v=l();if(0!==v.length){for(i=0;i<v.length;i++)d.push(r(v[i]));c||(c=!0,t.post(n.endpoint+"/v1/streams/"+o.streamid+"/events/batch",d,{headers:a}).success(function(t){u(d.length),c=!1}).error(function(t){c=!1}))}e(s,2e3)};s()};return{queueEvent:r,sendEvents:s,getQueue:a}}function HistoryCtrl(t,e){function n(t){var n=e("millisecondsToStringFilter")(t).split(":");return{hours:parseInt(n[0],10),minutes:parseInt(n[1],10),seconds:parseInt(n[2],10)}}function i(){var e=t.getQueue(),n={};return e.forEach(function(t){var e=t.when.split("T")[0];if(n[e]||(n[e]=[]),t.amount){var i=_.find(n[e],{event:t.event});i?i.amount+=t.amount:n[e].unshift({event:t.event,amount:t.amount})}else n[e].unshift(t)}),n}function o(){t.clear(),a.events=i()}var a=this;a.events=i(),a.dates=Object.keys(i()).sort().reverse(),a.humanizeTime=n,a.clearHistory=o}function historyService(t,e){function n(){var t=window.localStorage.history;return t?angular.fromJson(t):[]}function i(t){var e=n();e.push(t),window.localStorage.history=angular.toJson(e)}function o(){return l}function a(n){e.sendEventToApi(n),n.when=(new Date).toISOString(),e.sendEventToApi(n),l.push(n),r(),n.amount&&t.setLastAmountLogged(n.event,n.amount)}function r(){window.localStorage.history=JSON.stringify(l)}function c(){var t=n(),e={};return t.forEach(function(t){var n=t.when.split("T")[0];if(e[n]||(e[n]=[]),t.amount){var i=_.find(e[n],{event:t.event});i?i.amount+=t.amount:e[n].unshift({event:t.event,amount:t.amount})}else e[n].unshift(t)}),e}function u(){l=[],window.localStorage.history=[]}var l=JSON.parse(window.localStorage.history||"[]");return{getHistory:o,add:a,getGroupedEvents:c,getQueue:n,queueEvent:i,setGroupedEvents:c,clear:u}}function humanize(t){return t.locale("en",{calendar:{lastDay:"[Yesterday]",sameDay:"[Today]",lastWeek:"[Last] dddd LL",sameElse:"LL"}}),function(e){return t(e).calendar()}}function millisecondsToStringFilter(){return function(t){if(0!==t&&!t)return"";var e=Math.floor(t/1e3);t=Math.floor(t%1e3/100);var n=Math.floor(e/60);e-=60*n;var i=Math.floor(n/60);n-=60*i;var o=function(t,e){var n=Math.abs(t),i=Math.max(0,e-Math.floor(n).toString().length),o=Math.pow(10,i).toString().substr(1);return 0>t&&(o="-"+o),o+n},a="";return a+=o(i,2)+":"+o(n,2)+":"+o(e,2)+":"+o(t,2)}}angular.module("tracker",["ionic","ngAnimate","ngTouch","ngCordova","angularMoment","ngMaterial"]),angular.module("tracker").constant("API",{endpoint:"https://api.1self.co",appName:"co.1self.universaltracker",appVersion:"0.0.1",appId:"app-id-556d18e5ed9e4e67343332987f73a360",appSecret:"app-secret-0f5d09051e0bda5869e1a866bb4bc62afe30ae70fc8be92313a6e25ecc7d07db"}).config(["$ionicConfigProvider",function(t){t.navBar.alignTitle("center"),t.tabs.position("top")}]).run(["$ionicPlatform","AuthenticationService","EventSendService",function(t,e,n){t.ready(function(){e.authenticated()?n.sendEvents():e.authenticate(),window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!1),window.StatusBar&&StatusBar.styleDefault()})}]),angular.module("tracker").controller("ActivityCtrl",ActivityCtrl),ActivityCtrl.$inject=["$ionicPopup","$scope","activityService","historyService","activityTimingService","$filter","preferenceService","popupService"],angular.module("tracker").factory("activityService",activityService),angular.module("tracker").service("activityTimingService",activityTimingService),activityTimingService.$inject=["moment","$interval","NotificationService","historyService"],angular.module("tracker").controller("DashboardEditCtrl",DashboardEditCtrl),DashboardEditCtrl.$inject=["activityService"],angular.module("tracker").factory("oneSelfService",oneSelfService),oneSelfService.$inject=["API"],angular.module("tracker").config(routesConfig),routesConfig.$inject=["$stateProvider","$urlRouterProvider"],angular.module("tracker").service("AuthenticationService",["$http","API","$ionicPopup","$cordovaToast","EventSendService",function(t,e,n,i,o){var a=function(t,e){var o=function(t){if(t){console.log("Authenticated, yay!"),c();try{i.show("Authenticating...","long","bottom")}catch(n){console.error(new Error(n))}}else window.localStorage.api_credentials="Not authenticated",console.log("Not authenticated :(");e&&e(t)},a=window.localStorage.api_credentials;if("undefined"==typeof a||t){n.confirm({title:"Duration Data Policy",template:"<style>.button-continue{background-color: #00b8e7;}</style><p>1self Duration uses the 1self cloud to show you smart visualizations of your activity. Once connected you can also share and correlate your data. Your raw data will never be shown and it won't be possible to tell who you are or where you've been. Would you like to connect Duration to the 1self cloud?</p>",buttons:[{text:"No thanks",onTap:function(t){o(!1)}},{text:"Continue",type:"button-continue",onTap:function(t){o(!0)}}]})}},r={Authorization:e.appId+":"+e.appSecret},c=function(){t.post(e.endpoint+"/v1/streams",{},{headers:r}).success(function(t){window.localStorage.api_credentials=angular.toJson(t),window.localStorage.last_event_sent_index=-1,o.sendEvents();try{i.show("Authenticated","long","bottom")}catch(e){console.error(new Error(e))}}).error(function(t,e,n,i){})},u=function(){var t=window.localStorage.api_credentials;return"Not authenticated"!==t&&"undefined"!=typeof t};return{authenticate:a,authenticated:u}}]),angular.module("tracker").factory("NotificationService",NotificationService),NotificationService.$inject=["$ionicPlatform"],angular.module("tracker").factory("popupService",popupService),popupService.$inject=["$ionicPopup","$rootScope","activityService"],angular.module("tracker").factory("preferenceService",preferenceService),angular.module("tracker").controller("ChartCtrl",ChartCtrl),ChartCtrl.$inject=["oneSelfService"],angular.module("tracker").service("EventSendService",EventSendService),EventSendService.$inject=["$http","$timeout","API","$filter"],angular.module("tracker").controller("HistoryCtrl",HistoryCtrl),HistoryCtrl.$inject=["historyService","$filter"],angular.module("tracker").factory("historyService",historyService),historyService.$inject=["preferenceService","oneSelfService"],angular.module("tracker").filter("durationPartFilter",function(){return function(t){return t.substr(0,8)}}).filter("tenthsPartFilter",function(){return function(t){return t.substr(9,t.length)}}).filter("buildEventFilter",function(){return function(t){return{activity:t.title,dateTime:t.startDate,duration:t.duration/1e3}}}),angular.module("tracker").filter("humanize",humanize),humanize.$inject=["moment"],angular.module("tracker").filter("millisecondsToStringFilter",millisecondsToStringFilter);
}());
